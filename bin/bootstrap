#!/bin/sh

set -ex

cd "$(dirname "$0")/.." || exit 1

if [ "$NO_SELF_UPDATE" = '' ]
then
    git pull --rebase
fi

sudo apt update
sudo apt upgrade
sudo apt autoremove

sudo apt install \
    fish \
    git \
    docker.io docker-compose docker-buildx \
    gcc

if groups | grep -v docker
then
    sudo usermod -aG docker "$USER"
    >&2 echo "$USER was just now added to 'docker' group, and will need to login again"
    exit 2
fi

if [ -f "$HOME/.cargo/env" ]
then
    . "$HOME/.cargo/env"
fi

installed() { command -v "$1" >/dev/null; }

installed rustup \
    || curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

installed sigi \
    || cargo install sigi

installed hx \
    || {
        sudo add-apt-repository ppa:maveonair/helix-editor
        sudo apt update
        sudo apt install helix
    }

installed gh \
    || {
        sudo mkdir -p -m 755 /etc/apt/keyrings && wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
        && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y
    }
